services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-allure_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_this_password}
      POSTGRES_DB: ${POSTGRES_DB:-allure_events}
    volumes:
      - allure_postgres_data:/var/lib/postgresql/data
      - ./server/src/db/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    networks:
      - legacy-server
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-allure_user} -d ${POSTGRES_DB:-allure_events}"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  # Backend API
  backend:
    image: allure-events-backend:latest
    build:
      context: ./server
      dockerfile: Dockerfile
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-allure_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_this_password}
      POSTGRES_DB: ${POSTGRES_DB:-allure_events}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      PORT: 3001
      NODE_ENV: production
      FRONTEND_URL: https://allure.mangoia.com.br
      OPENAI_API_KEY: ${OPENAI_API_KEY:-your-api-key-here}
    networks:
      - legacy-server
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      labels:
        - traefik.enable=true
        - traefik.http.routers.allure-api.rule=Host(`allure.mangoia.com.br`) && PathPrefix(`/api`)
        - traefik.http.routers.allure-api.entrypoints=websecure
        - traefik.http.routers.allure-api.priority=2
        - traefik.http.routers.allure-api.tls.certresolver=letsencryptresolver
        - traefik.http.routers.allure-api.service=allure-api
        - traefik.http.services.allure-api.loadbalancer.server.port=3001
        - traefik.http.services.allure-api.loadbalancer.passHostHeader=true
      replicas: 1
      restart_policy:
        condition: on-failure

  # Frontend
  frontend:
    image: allure-events-frontend:latest
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VITE_API_URL: https://allure.mangoia.com.br/api
    networks:
      - legacy-server
    deploy:
      labels:
        - traefik.enable=true
        - traefik.http.routers.allure-frontend.rule=Host(`allure.mangoia.com.br`)
        - traefik.http.routers.allure-frontend.entrypoints=websecure
        - traefik.http.routers.allure-frontend.priority=1
        - traefik.http.routers.allure-frontend.tls.certresolver=letsencryptresolver
        - traefik.http.routers.allure-frontend.service=allure-frontend
        - traefik.http.services.allure-frontend.loadbalancer.server.port=80
        - traefik.http.services.allure-frontend.loadbalancer.passHostHeader=true
      replicas: 1
      restart_policy:
        condition: on-failure

networks:
  legacy-server:
    external: true
    name: legacy-server

volumes:
  allure_postgres_data:

