services:
  # Backend API
  backend:
    image: allure-events-backend:latest
    build:
      context: ./server
      dockerfile: Dockerfile
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-23d64722c2a32e72a430677238e08a82}
      POSTGRES_DB: ${POSTGRES_DB:-allure_events}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      PORT: 3001
      NODE_ENV: production
      FRONTEND_URL: https://allure.mangoia.com.br
      OPENAI_API_KEY: ${OPENAI_API_KEY:-your-api-key-here}
    networks:
      - legacy-server
    deploy:
      labels:
        - traefik.enable=true
        - traefik.docker.network=legacy-server
        - traefik.http.routers.allure-api.rule=Host(`allure.mangoia.com.br`) && PathPrefix(`/api`)
        - traefik.http.routers.allure-api.entrypoints=websecure
        - traefik.http.routers.allure-api.priority=2
        - traefik.http.routers.allure-api.tls.certresolver=letsencryptresolver
        - traefik.http.routers.allure-api.service=allure-api
        - traefik.http.services.allure-api.loadbalancer.server.port=3001
        - traefik.http.services.allure-api.loadbalancer.passHostHeader=true
      replicas: 1
      restart_policy:
        condition: on-failure
      update_config:
        failure_action: rollback
        delay: 10s

  # Frontend
  frontend:
    image: allure-events-frontend:latest
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VITE_API_URL: https://allure.mangoia.com.br/api
    networks:
      - legacy-server
    deploy:
      labels:
        - traefik.enable=true
        - traefik.docker.network=legacy-server
        - traefik.http.routers.allure-frontend.rule=Host(`allure.mangoia.com.br`)
        - traefik.http.routers.allure-frontend.entrypoints=websecure
        - traefik.http.routers.allure-frontend.priority=1
        - traefik.http.routers.allure-frontend.tls.certresolver=letsencryptresolver
        - traefik.http.routers.allure-frontend.service=allure-frontend
        - traefik.http.services.allure-frontend.loadbalancer.server.port=80
        - traefik.http.services.allure-frontend.loadbalancer.passHostHeader=true
      replicas: 1
      restart_policy:
        condition: on-failure

networks:
  legacy-server:
    external: true
    name: legacy-server

